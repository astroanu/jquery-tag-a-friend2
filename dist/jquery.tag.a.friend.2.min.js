/**
 * tagfriends2 Version: 2.1 URL: http://astroanu.github.io/jquery-tag-a-friend2/
 * Description: A facebook-like taggin interface Author: Anuradha Jayathilaka
 * (https://github.com/astroanu) Copyright: Copyright 2014 Anuradha Jayathilaka
 * License: MIT
 */
!function(a,b,c,d){"use strict";function g(e,g){this.element=e,this.tagger=a('<div autocomplete="off" autocorrect="off" autocapitalize="off" data-placeholder="'+g.placeholder+'" spellcheck="false" class="tagfriends-wrapper '+g.extraClass+'" contentEditable="true"></div>'),this.suggs=a('<ul class="tagfriends-tags-container"></ul>').addClass(g.suggClass).hide(),a(this.element).hide(),a("body").append(this.suggs),1==g.debug,a(this.element).before(this.tagger),rangy.init(),this.range=rangy.createRangyRange(),this.anchorNode=this.anchorOffset=this.focusNode=this.focusOffset=0,this.isCollapsed=!0,this.suggestionsVisible=!1,this.suggestionsDisabled=!1,this.suggestionsHover=!1,this.activeTagNode=null,this.lastw="",this.lastq="",this.tagged=[],this.link="";var h=this;a(this.tagger).bind("click keyup",function(a){q(h),h.range=rangy.createRangyRange(),h.range.selectNodeContents(this);var b=rangy.getSelection();h.anchorNode=b.anchorNode,h.anchorOffset=b.anchorOffset,h.focusNode=b.focusNode,h.focusOffset=b.focusOffset,h.isCollapsed=b.isCollapsed,(8==a.keyCode||39==a.keyCode)&&q(h),(8==a.keyCode||46==a.keyCode)&&p(h),40==a.keyCode&&h.suggs.find("a").first().focus(),t(h,function(a){h.suggestionsDisabled=a}),setTimeout(function(){u(h)===!0&&h.isCollapsed===!0&&h.suggestionsVisible===!1?y(h,function(a){h.suggestionsDisabled=a}):w(h)},h.opts.sugDelay),o(h)}),a(b).on("click",function(){w(h)}),a(this.suggs).on("scroll",function(a){a.preventDefault()}),a(this.suggs).on({mouseenter:function(){h.suggestionsHover=!0},mouseleave:function(){h.suggestionsHover=!1}},function(){}),a(this.suggs).on("keypress keydown","a",function(b){return 38==b.keyCode?(b.preventDefault(),a(this).parent().prev().children("a").focus(),a(this.suggs).scrollTop(a(this).prevAll().length*a(this).outerHeight()),!1):40==b.keyCode?(b.preventDefault(),a(this).parent().next().children("a").focus(),a(this.suggs).scrollTop(a(this).prevAll().length*a(this).outerHeight()),!1):(27==b.keyCode&&(w(h),h.range.setStartAfter(h.range.anchorNode)),void 0)}),a(this.suggs).on("hover",function(){a(this).blur()}),a(this.tagger).on("paste",function(a){try{a.preventDefault();var e="";a.originalEvent.clipboardData!==d?e=a.originalEvent.clipboardData.getData("Text"):c!==d&&(e=c.clipboardData.getData("Text"));var f=b.createTextNode(e);h.range.selectNodeContents(h.focusNode),h.range.setStart(h.focusNode,h.focusOffset),h.range.insertNode(f),h.range.setStartAfter(f),h.range.setEndAfter(f),rangy.getSelection().removeAllRanges(),rangy.getSelection().addRange(h.range),l(e)===!0&&""==h.link&&(m(h,e),h.link=e)}catch(a){h.opts.debug===!0}}),a(this.tagger).on("paste",".tag",function(a){return a.preventDefault(),!1}),a(this.tagger).on("click",".tag",function(){a(this).hasClass("tag")&&(a(this).parent().find(".tag").removeClass("active"),a(this).addClass("active"))}),a(this.tagger).on("blur click keypress keyup",function(b){13==b.keyCode&&b.preventDefault(),n(h),0==a(h.anchorNode).parents(".tag").length&&a(this).find(".tag").removeClass("active")}),a(this.tagger).on("change keydown keypress input",function(){this.textContent?this.dataset.divPlaceholderContent="true":delete this.dataset.divPlaceholderContent}),this.options=a.extend({},f,g),this.$el=a(e),this.$el.data(name,this),this._defaults=f;var i=this.$el.data(name+"-opts");this.opts=a.extend(this._defaults,g,i),this.init()}var e="tagfriends2",f={url:"",pageStart:1,pageKey:"curpage",pagePerKey:"pg_lmt",pagePer:500,queryKey:"q",dataObj:["ret","data"],tagFormat:"[@%?]",allowDuplicates:!1,debug:!1,scroller:null,onScrape:null,onUpdate:null,sugDelay:1e3,sugTpl:'<li><a data-val="{id}" href="">{text}</a></li>',extraClass:"",tagClass:"",suggClass:"",placeholder:""};Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length>>>0,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1}),g.prototype={init:function(){}},a.fn[e]=function(b){var c={refresh:function(b){n(a(b).data("plugin_"+e))},value:function(b){return n(a(b).data("plugin_"+e)),a(a(b).data("plugin_"+e).element).val()},clearUrl:function(b){a(b).data("plugin_"+e).link=""},clear:function(b){k(a(b).data("plugin_"+e))},focus:function(b){j(a(b).data("plugin_"+e))},blur:function(b){h(a(b).data("plugin_"+e))}};if(c[b]){var d=c[b];if("function"==typeof d)return d(this,Array.prototype.slice.call(arguments,1))}else{if("object"==typeof b||!b)return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new g(this,b))});a.error("Method "+b+" does not exist on jQuery."+e)}};var h=function(){a(i.tagger).blur()},j=function(b){a(b.tagger).focus()},k=function(b){a(b.tagger).text(""),a(b.element).empty(),b.tagged=[]},l=function(a){var b=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;return b.test(a)},m=function(a,b){"function"==typeof a.opts.onScrape&&a.opts.onScrape(b)},n=function(b){try{if(null!=b.range){var c=b.range.getNodes(),e="",f="";b.tagged=[],a.each(c,function(c,g){switch(a(g).prop("tagName")){case"SPAN":a(g).hasClass("tag")&&(e+=b.opts.tagFormat.replace("%?",a(g).data("id")),f=a(g).text(),b.tagged.push(a(g).data("id")));break;case d:a(g).text()!=f&&(e+=" "+a(g).text()+" ")}}),e=e.replace(/[\s\n\r]+/g," "),a(b.element).val(e)}}catch(g){b.opts.debug===!0}},o=function(b){if("function"==typeof b.opts.onUpdate){var c=a.trim(b.tagger.text());b.opts.onUpdate({count:0==c.length||c.length<0?0:c.length,text:b.range.toString(),code:a(b.element).val(),tags:b.tagged,link:b.link})}},p=function(c){var d=a(c.focusNode).parents(".tag");for(var e in c.tagged)if(c.tagged[e]==d.data("id")){c.tagged.splice(e,1);var f=b.createTextNode(" ");a(c.tagger).append(f),d.remove(),q(c)}c.tagger.trigger("click"),n(c)},q=function(c){try{c.range.setStart(c.anchorNode,c.anchorOffset),c.range.setEnd(c.anchorNode,c.anchorOffset);var d=b.createTextNode(" ");a(c.tagger).append(d)}catch(e){c.opts.debug===!0}},r=function(a,b){a=a.split("");for(var c=b;c>0;c--)if("@"==a[c])return c;return 0},s=function(a,b){a=a.split("");for(var c=b;c<a.length;c++)if("@"==a[c])return c;return a.length},t=function(a,b){if(null!=a.focusNode){var c=a.focusNode.nodeValue;null==c&&(c=""),c.split(" @");var e=r(c,a.focusOffset),f=s(c,a.focusOffset);f==e&&(f=c.length);var g=c.substring(e,f);b(g==a.lastw)}},u=function(b){if(null!=b.focusNode){var c=b.focusNode.nodeValue;null==c&&(c=""),c.split(" @");var e=r(c,b.focusOffset),f=s(c,b.focusOffset);f==e&&(f=c.length),b.lastw=c.substring(e,f);var g=a.trim(b.lastw);return"@"==g.substring(0,1)}return!1},v=function(c,d,e){if(c.tagged.indexOf(d)<0){c.range.selectNodeContents(c.focusNode),c.range.setStart(c.focusNode,c.focusOffset);var f=b.createElement("span");a(f).attr("data-id",d),a(f).attr("unselectable","on"),a(f).addClass("tag"),f.contentEditable=!1;var g=b.createElement("span");g.contentEditable=!1,a(g).attr("unselectable","on"),a(g).addClass("tag-inner"),a(g).addClass(c.opts.tagClass),g.appendChild(b.createTextNode(e)),f.appendChild(g),c.range.insertNode(f),c.range.selectNode(c.anchorNode);var h=r(c.range.toString(),c.range.toString().length-c.lastw.length),i=c.focusOffset;0==h&&c.range.toString().length-c.lastw.length>0&&(h=c.range.toString().length-c.lastw.length);var j=c.range.toString().split(" "),k=0;a.each(j,function(a,b){k=k+b.length+1;var c=b.split("");return"@"==c[0]?(h=k-b.length-1,void 0):void 0}),c.range.setStart(c.anchorNode,h),c.range.setEnd(c.anchorNode,i),c.range.deleteContents(),c.range.selectNodeContents(c.anchorNode),c.range.setStartAfter(f),c.range.setEndAfter(f),rangy.getSelection().removeAllRanges(),rangy.getSelection().addRange(c.range),c.opts.allowDuplicates===!1&&c.tagged.push(d),c.tagger.trigger("focus")}c.lastq=""},w=function(a){a.suggs.hide()},x=function(a,b){for(var c in b)a=a.replace("{"+c+"}",b[c]);return a},y=function(b,c){var d=b.lastw.substring(1).split(" ");if(d=d[0].split("_").join(" "),""!==d&&0==b.suggestionsDisabled&&b.lastq!=d){var e={};e[b.opts.pageKey]=b.opts.pageStart,e[b.opts.pagePerKey]=b.opts.pagePer,e[b.opts.queryKey]=d,a.ajax({url:b.opts.url,type:"post",data:e}).done(function(e){var f=e.ret.data;if(0==f.length)w(b),c(!0);else{a(b.suggs).empty(),a.each(f,function(c,d){b.tagged.indexOf(d.id)<0&&a(b.suggs).append(a(x(b.opts.sugTpl,d)))}),"function"==typeof b.opts.scroller&&b.opts.scroller(a(b.suggs)),b.suggs.find("a").bind("click",function(c){return c.preventDefault(),v(b,a(this).data("val"),a(this).text()),w(b),n(b),!1}),b.lastq=d;var h=a(b.tagger).offset(),i=a(b.tagger).css("padding-bottom");h.top=h.top+a(b.tagger).height()+2*parseInt(i)+1;var j=a(b.tagger).width()+parseInt(a(b.tagger).css("padding-left"))+parseInt(a(b.tagger).css("padding-right"));b.suggs.css({top:h.top,left:h.left,width:j}),b.suggs.show(),c(!1)}})}}}(jQuery,document,window);
