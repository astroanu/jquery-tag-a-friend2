/**
 * jquery-tag-a-friend2
 * Version: 2.0
 * URL: http://astroanu.github.io/jquery-tag-a-friend2/
 * Description: A facebook-like taggin interface 
 * Author: Anuradha Jayathilaka (https://github.com/astroanu)
 * Copyright: Copyright 2014 Anuradha Jayathilaka
 * License: MIT
 */
(function(e,t,n,r){"use strict";function o(i,o){this.element=i;this.id=e(this.element).prop("id")+"-tagger";this.tagger=e('<div id="'+this.id+'" class="tagfriends-wrapper" contentEditable="true"></div>');this.suggs=e('<ul class="tagfriends-tags-container"></ul>').hide();e("body").append(this.suggs);e(this.element).before(this.tagger);rangy.init();this.range=rangy.createRangyRange();this.el=t.getElementById(this.id);this.anchorNode=this.anchorOffset=this.focusNode=this.focusOffset=0;this.isCollapsed=true;this.suggestionsVisible=false;this.suggestionsDisabled=false;this.suggestionsHover=false;this.activeTagNode=null;this.lastw="";this.tagged=[];this.link="";var h=this;e(this.el).bind("click keyup",function(e){h.range=rangy.createRangyRange();h.range.selectNodeContents(this);var t=rangy.getSelection();h.anchorNode=t.anchorNode;h.anchorOffset=t.anchorOffset;h.focusNode=t.focusNode;h.focusOffset=t.focusOffset;h.isCollapsed=t.isCollapsed;if(e.keyCode==8||e.keyCode==39){c(h)}if(e.keyCode==8||e.keyCode==46){l(h)}if(e.keyCode==40){h.suggs.find("a").first().focus()}d(h,function(e){h.suggestionsDisabled=e});if(v(h)===true&&h.isCollapsed===true&&h.suggestionsVisible===false){y(h,function(e){h.suggestionsDisabled=e})}else{g(h)}});e(this.suggs).on("scroll",function(e){e.preventDefault()});e(this.suggs).on({mouseenter:function(){h.suggestionsHover=true},mouseleave:function(){h.suggestionsHover=false}},function(){});e(this.suggs).on("keypress keyup","a",function(t){if(t.keyCode==38){t.preventDefault();e(this).parent().prev().children("a").focus()}if(t.keyCode==40){t.preventDefault();e(this).parent().next().children("a").focus()}if(t.keyCode==27){g(h);h.range.setStartAfter(h.range.anchorNode)}});e(this.el).on("paste",function(e){try{e.preventDefault();var i="";if(e.originalEvent.clipboardData!==r){i=e.originalEvent.clipboardData.getData("Text")}else if(n!==r){i=n.clipboardData.getData("Text")}var s=t.createTextNode(i);h.range.selectNodeContents(h.focusNode);h.range.setStart(h.focusNode,h.focusOffset);h.range.insertNode(s);h.range.setStartAfter(s);h.range.setEndAfter(s);rangy.getSelection().removeAllRanges();rangy.getSelection().addRange(h.range);if(u(i)===true&&h.link==""){a(h,i);h.link=i}}catch(e){if(h.opts.debug===true){}}});e(this.el).on("paste",".tag",function(e){e.preventDefault();return false});e(this.el).on("click",".tag",function(){if(e(this).hasClass("tag")){e(this).parent().find(".tag").removeClass("active");e(this).addClass("active")}});e(this.el).on("blur click keypress keyup",function(t){if(t.keyCode==13){t.preventDefault()}f(h);if(e(h.anchorNode).parents(".tag").length==0){e(this).find(".tag").removeClass("active")}});this.options=e.extend({},s,o);this.$el=e(i);this.$el.data(name,this);this._defaults=s;var p=this.$el.data(name+"-opts");this.opts=e.extend(this._defaults,o,p);this.init()}var i="tagfriends2";var s={url:"",pageStart:1,pageKey:"curpage",pagePerKey:"pg_lmt",pagePer:10,queryKey:"q",dataObj:["ret","data"],tagFormat:"[@%?]",allowDuplicates:false,debug:false,scrape:null};if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e){var t=this.length>>>0;var n=Number(arguments[1])||0;n=n<0?Math.ceil(n):Math.floor(n);if(n<0)n+=t;for(;n<t;n++){if(n in this&&this[n]===e)return n}return-1}}o.prototype={init:function(){}};e.fn[i]=function(t){var n={refresh:function(){f(e(this).data("plugin_"+i))},value:function(){f(e(this).data("plugin_"+i));return e(e(this).data("plugin_"+i).element).val()}};if(n[t]){return n[t].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof t==="object"||!t){return this.each(function(){if(!e.data(this,"plugin_"+i)){e.data(this,"plugin_"+i,new o(this,t))}})}else{e.error("Method "+t+" does not exist on jQuery."+i)}};var u=function(e){var t=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;return t.test(e)};var a=function(e,t){if(typeof e.opts.scrape=="function"){e.opts.scrape(t,e.tagger)}};var f=function(t){try{if(t.range!=null){var n=t.range.getNodes();var i="";var s="";e.each(n,function(n,o){switch(e(o).prop("tagName")){case"SPAN":if(e(o).hasClass("tag")){i+=t.opts.tagFormat.replace("%?",e(o).data("id"));s=e(o).text()}break;case r:if(e(o).text()!=s){i+=" "+e(o).text()+" "}break}});i=i.replace(/[\s\n\r]+/g," ");e(t.element).val(i)}}catch(o){if(t.opts.debug===true){}}};var l=function(t){var n=e(t.focusNode).parents(".tag");for(var r in t.tagged){if(t.tagged[r]==n.data("id")){t.tagged.splice(r,1);n.remove()}}};var c=function(n){if(n.focusNode!=null){var r=n.focusNode.toString();var i=r.length;if(r.substr(i,-1)!=" "){var s=t.createTextNode(" ");e(n.el).append(s)}}};var h=function(e,t){e=e.split("");for(var n=t;n>0;n--){if(e[n]=="@"){return n}}return 0};var p=function(e,t){for(var n=t;n<e.length;n++){if(e[n]=="@"){return n}}return e.length};var d=function(e,t){if(e.focusNode!=null){var n=e.focusNode.nodeValue;if(n==null)n="";var r=n.split("@");var i=h(n,e.focusOffset);var s=p(n,e.focusOffset);if(s==i)s=n.length;var o=n.substring(i,s);t(o==e.lastw)}};var v=function(t){if(t.focusNode!=null){var n=t.focusNode.nodeValue;if(n==null)n="";var r=n.split("@");var i=h(n,t.focusOffset);var s=p(n,t.focusOffset);if(s==i)s=n.length;t.lastw=n.substring(i,s);var o=e.trim(t.lastw);return o.substring(0,1)=="@"}return false};var m=function(n,r,i){if(n.tagged.indexOf(r)<0){n.range.selectNodeContents(n.focusNode);n.range.setStart(n.focusNode,n.focusOffset);var s=t.createElement("span");e(s).attr("data-id",r);e(s).attr("unselectable","on");e(s).addClass("tag");s.contentEditable=false;var o=t.createElement("span");o.contentEditable=false;e(o).attr("unselectable","on");e(o).addClass("tag-inner");o.appendChild(t.createTextNode(i));s.appendChild(o);n.range.insertNode(s);n.range.selectNode(n.anchorNode);var u=h(n.range.toString(),n.range.toString().length-n.lastw.length);var a=n.focusOffset;if(u==0&&n.range.toString().length-n.lastw.length>0){u=n.range.toString().length-n.lastw.length}n.range.setStart(n.focusNode,u);n.range.setEnd(n.focusNode,a);n.range.deleteContents();n.range.selectNodeContents(n.focusNode);c(n);n.range.setStartAfter(s);n.range.setEndAfter(s);rangy.getSelection().removeAllRanges();rangy.getSelection().addRange(n.range);if(n.opts.allowDuplicates===false){n.tagged.push(r)}n.tagger.trigger("click");f(n)}};var g=function(e){e.suggs.hide()};var y=function(t,n){var r=t.lastw.substring(1);if(r!==""&&t.suggestionsDisabled==false){var i={};i[t.opts.pageKey]=t.opts.pageStart;i[t.opts.pagePerKey]=t.opts.pagePer;i[t.opts.queryKey]=r;e.ajax({url:t.opts.url,type:"post",data:i}).done(function(r){var i=r.ret.data;if(i.length==0){g(t);n(true)}else{e(t.suggs).empty();e.each(i,function(n,r){var i=e('<li><a data-val="'+r.id+'" href="">'+r.text+"</a></li>");e(t.suggs).append(i)});t.suggs.find("a").bind("click",function(n){n.preventDefault();m(t,e(this).data("val"),e(this).text());g(t);f(t);return false});var s=e(t.tagger).offset();var o=e(t.tagger).css("padding-bottom");s.top=s.top+e(t.tagger).height()+parseInt(o)*2+1;t.suggs.css({top:s.top,left:s.left});t.suggs.show();n(false)}})}}})(jQuery,document,window)